apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: jellyfin-mpv-builder
spec:
  schedule: "0 0 * * 0"
  concurrencyPolicy: "Replace"
  startingDeadlineSeconds: 0
  workflowSpec:
    entrypoint: buildah-build
    templates:
    - name: buildah-build
      inputs:
        artifacts:
          - name: source
            path: /src
            git:
              repo: https://git.local.ongy.net/ongy/dockerfiles.git
              revision: HEAD
      outputs:
        artifacts:
        - name: container-image
          path: /out/image
      container:
        name: buildah
        image: quay.io/buildah/stable:latest
        workingDir: /src
        securityContext:
          privileged: true # For fuse access
        command:
        - sh
        args:
        - -c
        - |
          mkdir -p /out
          buildah bud -f jellyfin-mpv/Dockerfile --tag cr.local.ongy.net:jellyfin-mpv jellyfin-mpv
          buildah push cr.local.ongy.net:jellyfin-mpv oci-archive:/out/image

